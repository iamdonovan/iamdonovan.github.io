<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>week 1 - dem processing using micmac &mdash; iamdonovan  documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="week 2 - dem differencing" href="week2.html" />
    <link rel="prev" title="software setup" href="setup.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> iamdonovan
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../whataboutbob.html">about me</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">teaching and related resources</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../index.html#unis-spring-2017">unis (spring 2017)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../index.html#esa-cryosphere-training-course-june-2018">esa cryosphere training course (june 2018)</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../index.html#ulster-2020-present">ulster (2020-present)</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../../egm310/index.html">EGM310: introduction to gis and remote sensing</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="../index.html">EGM702: photogrammetry and advanced image analysis</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="../lectures.html">lectures</a></li>
<li class="toctree-l4 current"><a class="reference internal" href="index.html">practicals</a></li>
<li class="toctree-l4"><a class="reference internal" href="../resources.html">additional resources</a></li>
<li class="toctree-l4"><a class="reference internal" href="../index.html#content">content</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../egm703/index.html">EGM703: advanced active and passive remote sensing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../egm722/index.html">EGM722: programming for gis and remote sensing</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../research/index.html">ongoing and past research projects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../github.html">github projects</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">iamdonovan</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">teaching and related resources</a> &raquo;</li>
          <li><a href="../index.html">EGM702: photogrammetry and advanced image analysis</a> &raquo;</li>
          <li><a href="index.html">practicals</a> &raquo;</li>
      <li>week 1 - dem processing using micmac</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../_sources/teaching/egm702/practicals/week1.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="week-1-dem-processing-using-micmac">
<h1>week 1 - dem processing using micmac<a class="headerlink" href="#week-1-dem-processing-using-micmac" title="Permalink to this headline"></a></h1>
<div class="section" id="introduction">
<h2>introduction<a class="headerlink" href="#introduction" title="Permalink to this headline"></a></h2>
<p><strong>Be sure to download all the data from the Practical 1 area on Blackboard before starting, or from the</strong> <a class="reference external" href="https://drive.google.com/uc?id=1rwu32Wms_jvrmzkMRckD8kwcgl98qn4k&amp;export=download">google drive link</a><strong>, then extract the zip file. You should
have the following files/folders available:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>├─ AR5840034159994.tif
├─ AR5840034159995.tif
├─ AR5840034159996.tif
├─ AR5840034159997.tif
├─ AR5840034159998.tif
├─ AR5840034159999.tif
├─ filtre.tif
├─ id_fiducial.txt
├─ id_gcps.txt
├─ GCPs.txt
├─ MicMac-LocalChantierDescripteur.xml
├─ NAIP_Images/
└─ Ori-InterneScan/
    └─ MeasuresCamera.xml
</pre></div>
</div>
<p>In this practical, we’re going to work on processing a digital elevation model (DEM) and orthophotos using a collection of aerial photos acquired in 1984 over Mt St Helens, a volcano in Washington state, USA. During the 1980s and early 1990s, the volcano erupted several times, including an eruption in May 1980 that collapsed the entire north face of the mountain.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The instructions/images below assume that you are using MicMac in a Windows environment; the commands will be the same for a MacOS/Linux environment, but you’ll need to open
a terminal rather than the Windows command prompt.</p>
</div>
</div>
<div class="section" id="getting-started">
<h2>getting started<a class="headerlink" href="#getting-started" title="Permalink to this headline"></a></h2>
<p>To get started, open the Windows command prompt, either by using the search bar, or <strong>Start</strong> &gt; <strong>Windows System</strong> &gt; <strong>Command Prompt</strong>.</p>
<p>To change folders from the command line, you will use the <cite>cd</cite> command. When you open the command prompt, you should be in your <strong>home</strong> folder (for me, this is <strong>C:\Users\bob</strong>). At the command prompt, navigate to the folder where you have saved the data above (for me, this is <strong>C:\Data\MtStHelens</strong>) by typing <cite>cd</cite> followed by the directory name (<strong>note the space between the command and the directory</strong>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">bob</span><span class="o">&gt;</span><span class="n">cd</span> <span class="s2">&quot;C:\Data\MtStHelens</span><span class="se">\&quot;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In the line above, <code class="docutils literal notranslate"><span class="pre">C:\Users\bob</span></code> is the current directory, and <code class="docutils literal notranslate"><span class="pre">&gt;</span></code> is the command prompt - if you want to copy/paste the above command, be sure to copy the text <em>after</em> the <code class="docutils literal notranslate"><span class="pre">&gt;</span></code> (i.e., <code class="docutils literal notranslate"><span class="pre">cd</span> <span class="pre">C:\Data\MtStHelens</span></code>).</p>
<p>For the remaining commands, I will omit the command prompt and only write the command that you will need to use.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you have saved your data to another drive (e.g., <code class="docutils literal notranslate"><span class="pre">D:</span></code>), you will first need to change to the correct drive, <strong>before</strong> you try to change directories. So, if your data are saved to <code class="docutils literal notranslate"><span class="pre">D:\EGM702\Data</span></code>, you will need to first change drives by entering <strong>just</strong> the drive name followed by a colon:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">D</span><span class="p">:</span>
<span class="o">&gt;</span> <span class="n">cd</span> <span class="n">EGM702</span>\<span class="n">Data</span>
</pre></div>
</div>
<p>in order to change to the correct directory. Note that you’ll need to do this each time you open the command prompt - the default starting disk is <code class="docutils literal notranslate"><span class="pre">C:</span></code>.</p>
</div>
<p>To see the contents of the directory, use the <code class="docutils literal notranslate"><span class="pre">dir</span></code> command. You should see something similar to the picture below:</p>
<a class="reference internal image-reference" href="../../../_images/dir_output.png"><img alt="the outputs of the dir command" class="align-center" src="../../../_images/dir_output.png" style="width: 600px;" /></a>
<p>We’re going to run each of the processing steps in MicMac using the command line interface. If you are curious about what a particular command or input parameter does, you can always type <code class="docutils literal notranslate"><span class="pre">-help</span></code> after the command, and information about how to use the command will be printed to the screen. For example, for the first command we will use, you can type the following at the command prompt:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mm3d</span> <span class="n">SaisieAppuisInitQt</span> <span class="o">-</span><span class="n">help</span>
</pre></div>
</div>
<p>This will open the following window:</p>
<a class="reference internal image-reference" href="../../../_images/saisie_help.png"><img alt="the saisieappuis help window" class="align-center" src="../../../_images/saisie_help.png" style="width: 400px;" /></a>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In a MacOS/linux environment, the help message may just display to the terminal window, rather than opening a popup window.</p>
</div>
<p>The help text shows you the arguments that you have to use to run the command, as well as optional named arguments and their meanings. For other commands, such as <code class="docutils literal notranslate"><span class="pre">Malt</span></code>, the text will print directly to the command window.</p>
</div>
<div class="section" id="resampling-the-images">
<h2>resampling the images<a class="headerlink" href="#resampling-the-images" title="Permalink to this headline"></a></h2>
<p>The first thing we have to do is make sure the images are re-sampled to a consistent geometry. To do this in MicMac, we use the <code class="docutils literal notranslate"><span class="pre">SaisieAppuisInitQT</span></code> command. We’ll start with the first image, <strong>AR5840034159994.tif</strong>. To begin, type the following (or copy &amp; paste) at the command prompt (note the lack of space in <strong>MeasuresIm-AR5840034159994.tif.xml</strong>). You may also have to re-type the quotation marks, as the command prompt may not recognize them:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mm3d</span> <span class="n">SaisieAppuisInitQT</span> <span class="s2">&quot;AR5840034159994.tif&quot;</span> <span class="n">NONE</span> <span class="n">id_fiducial</span><span class="o">.</span><span class="n">txt</span> <span class="n">MeasuresIm</span><span class="o">-</span><span class="n">AR5840034159994</span><span class="o">.</span><span class="n">tif</span><span class="o">.</span><span class="n">xml</span>
</pre></div>
</div>
<p>This will open the window shown below:</p>
<a class="reference internal image-reference" href="../../../_images/saisie_fid.png"><img alt="the saisie window" class="align-center" src="../../../_images/saisie_fid.png" style="width: 600px;" /></a>
<p>You’ll need to set the locations of each of the fiducial marks in the image (there are 8 in total). They are numbered as you can see in the image above, with <strong>P1</strong> located in the lower left corner of the image. You can pan around the viewer by pressing the centre wheel on your mouse, or zoom in/out using the scroll wheel on your mouse. Zoom in on the <strong>P1</strong> mark, then click on <strong>P1</strong> in the table on the right side of the frame, and finally click on the dot in the centre of the fiducial mark:</p>
<a class="reference internal image-reference" href="../../../_images/fiducial.png"><img alt="a fiducial marker" class="align-center" src="../../../_images/fiducial.png" style="width: 200px;" /></a>
<p>You want to get as close to the middle of the dot as possible. You might notice that this isn’t easy for <strong>P6</strong>, which is partly obscured - just do the best that you can. When you’re satisfied you have the right point, continue for the remainder of the points, then select <strong>File</strong> &gt; <strong>Exit</strong>.</p>
<p>To input the points for the next image (<strong>AR5840034159995.tif</strong>), you’ll need to change both the input filename and the output filename in the command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mm3d</span> <span class="n">SaisieAppuisInitQT</span> <span class="s2">&quot;AR5840034159995.tif&quot;</span> <span class="n">NONE</span> <span class="n">id_fiducial</span><span class="o">.</span><span class="n">txt</span> <span class="n">MeasuresIm</span><span class="o">-</span><span class="n">AR5840034159995</span><span class="o">.</span><span class="n">tif</span><span class="o">.</span><span class="n">xml</span>
</pre></div>
</div>
<p>Once that’s done, repeat this for the remaining images in the directory. You’ll notice that micmac has created two MeasuresIm files for each image, one with an extension <strong>-S2D.xml</strong>, and the other with an extension <strong>-S3D.xml</strong>. You’ll need to move each of the <strong>S2D.xml</strong> files:</p>
<ul class="simple">
<li><p>MeasuresIm-AR5840034159994.tif-S2D.xml</p></li>
<li><p>MeasuresIm-AR5840034159995.tif-S2D.xml</p></li>
<li><p>MeasuresIm-AR5840034159996.tif-S2D.xml</p></li>
<li><p>MeasuresIm-AR5840034159997.tif-S2D.xml</p></li>
<li><p>MeasuresIm-AR5840034159998.tif-S2D.xml</p></li>
<li><p>MeasuresIm-AR5840034159999.tif-S2D.xml</p></li>
</ul>
<p>into the <strong>Ori-InterneScan</strong> directory, being sure to remove the <strong>-S2D</strong> from each name. <strong>Ori-InterneScan/</strong> should now
look like this:</p>
<a class="reference internal image-reference" href="../../../_images/ori-internescan_dir.png"><img alt="the contents of the ori-internescan directory" class="align-center" src="../../../_images/ori-internescan_dir.png" style="width: 600px;" /></a>
<p>At this point, you can delete the <strong>S3D</strong> files – the program creates them, but we don’t actually need them. Next up, re-sample the images using the fiducial marks you have identified, so that each image has the same geometry:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mm3d</span> <span class="n">ReSampFid</span> <span class="s2">&quot;AR.*tif&quot;</span> <span class="mf">0.05</span>
</pre></div>
</div>
<p>This will re-sample each of the images to a resolution of 50 microns (i.e., 1 pixel = 0.05 mm). If you’re worried about space, you can re-sample to 100 microns if need be (change 0.05 to 0.1 in the command above). Note that this will lower the final resolution of your DEM and orthophoto, though, from about 4 metres to 8 metres.</p>
<p>If the command runs correctly, you should see the names of each image printed out, along with the residuals (in # of pixels) and the amount of time it took to re-sample each image.</p>
<p>As long as the residuals are small (&lt;2 pixels or so), you can continue. If not, you’ll need to adjust your fiducial mark selection, and run <code class="docutils literal notranslate"><span class="pre">ReSampFid</span></code> again. When you have successfully re-sampled the images, create a new directory called <strong>OrigImg</strong> and move the original image files into it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="n">OrigImg</span>
<span class="n">move</span> <span class="n">AR</span><span class="o">*.</span><span class="n">tif</span> <span class="n">OrigImg</span>
</pre></div>
</div>
<p>Note that the wildcard, or asterisk (*), symbol tells the computer to move anything that matches the pattern <code class="docutils literal notranslate"><span class="pre">AR(something).tif</span></code> into the directory <strong>OrigImg</strong> – so it should move all of the scanned images.</p>
</div>
<div class="section" id="computing-the-relative-orientation">
<h2>computing the relative orientation<a class="headerlink" href="#computing-the-relative-orientation" title="Permalink to this headline"></a></h2>
<p>The next step is to find tie points to help compute the relative orientation of the images. First, run <code class="docutils literal notranslate"><span class="pre">Tapioca</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mm3d</span> <span class="n">Tapioca</span> <span class="n">MulScale</span> <span class="s2">&quot;OIS.*tif&quot;</span> <span class="mi">400</span> <span class="mi">1200</span>
</pre></div>
</div>
<p>This will compute tie points at two resolutions to help speed things up. Once this completes, you can filter the tie points, to make sure that they don’t include things like the fiducial marks or any writing on the image frame:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mm3d</span> <span class="n">HomolFilterMasq</span> <span class="s2">&quot;OIS.*tif&quot;</span> <span class="n">GlobalMasq</span><span class="o">=</span><span class="n">filtre</span><span class="o">.</span><span class="n">tif</span>
</pre></div>
</div>
<p>If the provided <strong>filtre.tif</strong> doesn’t work, you can watch the video <a class="reference external" href="https://youtu.be/xOHEkKiiRnM">here</a> to make your own.</p>
<p>After this, you can compute the relative orientation using <code class="docutils literal notranslate"><span class="pre">Tapas</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mm3d</span> <span class="n">Tapas</span> <span class="n">RadialBasic</span> <span class="s2">&quot;OIS.*tif&quot;</span> <span class="n">Out</span><span class="o">=</span><span class="n">Relative</span> <span class="n">SH</span><span class="o">=</span><span class="n">HomolMasqFiltered</span> <span class="n">LibFoc</span><span class="o">=</span><span class="mi">0</span>
</pre></div>
</div>
<p>For these images, the estimated focal length is 302.26 mm, based on the value recorded by the camera at the time of acquisition. At this stage, we will keep the focal length fixed (<code class="docutils literal notranslate"><span class="pre">LibFoc=0</span></code>) to this value (which is stored in <strong>MicMac-LocalChantierDescripteur.xml</strong>). This will calibrate the relative orientation using a basic radial distortion camera model (<code class="docutils literal notranslate"><span class="pre">RadialBasic</span></code>). If you continue to use MicMac for your own projects, you might need to change the camera model used – you can check out the <a class="reference external" href="https://micmac.ensg.eu/index.php/Accueil">MicMac Wiki</a> to see the other camera models available.</p>
<p>Now, let’s visualize the relative orientation using <code class="docutils literal notranslate"><span class="pre">AperiCloud</span></code> and <strong>MeshLab</strong> (or <strong>CloudCompare</strong>). First, run this command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mm3d</span> <span class="n">AperiCloud</span> <span class="s2">&quot;OIS.*tif&quot;</span> <span class="n">Relative</span> <span class="n">SH</span><span class="o">=</span><span class="n">HomolMasqFiltered</span>
</pre></div>
</div>
<p>When this completes, you should have a file called <strong>AperiCloud_Relative_MasqFiltered.ply</strong> in your directory. Open either <strong>MeshLab</strong> or <strong>CloudCompare</strong>, and then open this file. You should see something like this:</p>
<a class="reference internal image-reference" href="../../../_images/meshlab.jpg"><img alt="the relative orientation displayed in meshlab" class="align-center" src="../../../_images/meshlab.jpg" style="width: 600px;" /></a>
<p>Each of the cameras is shown as a green and red box, and the tie points are displayed as black and white pixels. As long as you can see six cameras and the basic shape of a volcano, you can close <strong>MeshLab</strong> or <strong>CloudCompare</strong>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you encounter errors along the way, you can e-mail me, or try searching google for potential resolutions. Be warned that a number of the results, as well as the error messages, may be in French. There is also a forum and a <a class="reference external" href="https://reddit.com/r/micmac">subreddit</a> where you can ask the developers and other users for help - most people are quite helpful and happy to help.</p>
</div>
</div>
<div class="section" id="computing-the-absolute-orientation">
<h2>computing the absolute orientation<a class="headerlink" href="#computing-the-absolute-orientation" title="Permalink to this headline"></a></h2>
<p>At this point, we’re ready to compute the absolute orientation of the images - taking them from the relative geometry to the real world.</p>
<p>To do this, we need to find a number of Ground Control Points (GCPs), which will help the software solve the absolute orientation of the cameras, and compute the 3-dimensional location for each pixel in the images.</p>
<p>To help save some time, and because finding GCPs in 30+ year old aerial photos can be difficult, I’ve provided a number of GCPs that you should be able to find in the images. In your folder, you should have a file, <strong>GCPs.txt</strong>, which contains the name and x, y, and z location for the GCPs. To make the file usable by MicMac, you need to convert it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mm3d</span> <span class="n">GCPConvert</span> <span class="n">AppInFile</span> <span class="n">GCPs</span><span class="o">.</span><span class="n">txt</span>
</pre></div>
</div>
<p>This will create a file, <strong>GCPs.xml</strong>, which MicMac will read to do the calibration. Before we can do that, though, we have to find the image locations for each of the GCPs. <strong>GCPs.txt</strong> has 33 different points, picked from US Dept of Agriculture <a class="reference external" href="https://www.fsa.usda.gov/programs-and-services/aerial-photography/imagery-programs/naip-imagery/">National Agriculture Imagery Program (NAIP) orthophotos</a>, which are provided in the directory NAIP_Images. Rather than trying to find each point individually, we can first use MicMac to estimate where each of the points should be. First, run the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mm3d</span> <span class="n">SaisieAppuisInitQT</span> <span class="s2">&quot;OIS-Reech_AR5840034159995.tif&quot;</span> <span class="n">Relative</span> <span class="n">id_gcps</span><span class="o">.</span><span class="n">txt</span> <span class="n">MeasuresInit</span><span class="o">.</span><span class="n">xml</span>
</pre></div>
</div>
<p>This will open the window shown below:</p>
<a class="reference internal image-reference" href="../../../_images/gcp0.png"><img alt="the first GCP input window" class="align-center" src="../../../_images/gcp0.png" style="width: 600px;" /></a>
<p>You might also want to see what the GCPs actually look like on the ground. To do this, you can load the NAIP Imagery into either <strong>QGIS</strong> or <strong>ArcGIS</strong>. You can add the images individually, or you can add them all at once using the Virtual Raster (<strong>mtsthelens.vrt</strong>), which should work for either software.</p>
<p>To display <strong>GCPs.txt</strong> in QGIS, you can add them as a <strong>Delimited Text Layer</strong>. Choose <strong>Custom Delimiter</strong> under <strong>File Format</strong>, and set the delimiter to <cite>Space</cite>. Under <strong>Record and Fields Options</strong>, set the <strong>Number of header lines to discard</strong> as <code class="docutils literal notranslate"><span class="pre">2</span></code>, and uncheck <strong>First record has field names</strong>. Set <code class="docutils literal notranslate"><span class="pre">field_2</span></code> to be the <strong>X field</strong>, and <code class="docutils literal notranslate"><span class="pre">field_3</span></code> to be the <strong>Y field</strong>. Finally, set the <strong>Geometry CRS</strong> to be <code class="docutils literal notranslate"><span class="pre">EPSG:32610</span> <span class="pre">–</span> <span class="pre">WGS84/UTM</span> <span class="pre">zone</span> <span class="pre">10N</span></code>, as shown below, then click <strong>Add</strong>:</p>
<a class="reference internal image-reference" href="../../../_images/qgis_import.png"><img alt="the qgis import as text dialogue" class="align-center" src="../../../_images/qgis_import.png" style="width: 600px;" /></a>
<p>This will load the points into the map. You can also display the names of the points (<strong>field_1</strong> in the example above) as labels, so that you know which point is which on the map.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To load the points in ArcMap or ArcGIS Pro, you might first need to replace the spaces in the text file with commas.</p>
</div>
<p>We’ll start by inputting <strong>GCP0</strong>. This GCP is the junction of two forest roads to the southwest of the mountain (but in the upper left of image <strong>9996</strong>, in the far upper left of image <strong>9997</strong>, and in the upper center of image <strong>9995</strong>). Open image <strong>9995</strong>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mm3d</span> <span class="n">SaisieAppuisInitQT</span> <span class="s2">&quot;OIS-Reech_AR5840034159995.tif&quot;</span> <span class="n">Relative</span> <span class="n">id_gcps</span><span class="o">.</span><span class="n">txt</span> <span class="n">MeasuresInit</span><span class="o">.</span><span class="n">xml</span>
</pre></div>
</div>
<p>then zoom in toward the upper middle of the image <strong>9995</strong>. The junction should look like this:</p>
<a class="reference internal image-reference" href="../../../_images/gcp0_location.png"><img alt="the first GCP" class="align-center" src="../../../_images/gcp0_location.png" style="width: 400px;" /></a>
<p>As with the fiducial marks, click the point name in the table on the right (<strong>GCP0</strong>), then click on its location in the image. Close the window (<strong>File</strong> &gt; <strong>Exit</strong>). Next, open image <strong>9996</strong>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mm3d</span> <span class="n">SaisieAppuisInitQT</span> <span class="s2">&quot;OIS-Reech_AR5840034159996.tif&quot;</span> <span class="n">Relative</span> <span class="n">id_gcps</span><span class="o">.</span><span class="n">txt</span> <span class="n">MeasuresInit</span><span class="o">.</span><span class="n">xml</span>
</pre></div>
</div>
<p>You should see that the point <strong>GCP0</strong> is now displayed in <strong>9996</strong>, but it’s not quite in the correct location, and it’s yellow rather than green. Zoom in on the marker, then hold down the <strong>CTRL</strong> button and click and drag the marker to the correct location. When you’re satisfied with its location, right-click and select <code class="docutils literal notranslate"><span class="pre">Validate</span></code> – it should turn green.</p>
<p>To start with, we’ll only put in a few of the GCPs. I recommend doing <strong>GCP6</strong> next – you should be able to find it in images <strong>9996</strong>, <strong>9997</strong>, and <strong>9998</strong>. It should look something like this:</p>
<a class="reference internal image-reference" href="../../../_images/gcp6.png"><img alt="the second GCP" class="align-center" src="../../../_images/gcp6.png" style="width: 600px;" /></a>
<p>Close the window, and open up image <strong>9997</strong>. Here, you should be able to find both <strong>GPC0</strong> and <strong>GCP6</strong>, as well as <strong>GCP13</strong> in the lower right corner of the image:</p>
<a class="reference internal image-reference" href="../../../_images/image9997.png"><img alt="image 9997 showing 2 GCPs located" class="align-center" src="../../../_images/image9997.png" style="width: 600px;" /></a>
<p>Continue on to images <strong>9998</strong> and <strong>9999</strong>. Once you have put in these GCPs (<strong>GCP0</strong>, <strong>GCP6</strong> and <strong>GCP13</strong>), you can run the <code class="docutils literal notranslate"><span class="pre">GCPBascule</span></code> command to make a rough estimate of where the remaining GCPs should fall in each of the images:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mm3d</span> <span class="n">GCPBascule</span> <span class="s2">&quot;OIS.*tif&quot;</span> <span class="n">Relative</span> <span class="n">TerrainInit</span> <span class="n">GCPs</span><span class="o">.</span><span class="n">xml</span> <span class="n">MeasuresInit</span><span class="o">-</span><span class="n">S2D</span><span class="o">.</span><span class="n">xml</span>
</pre></div>
</div>
<p>This will compute a rough transformation between the relative geometry and the real-world coordinates. You should see something like this in the <strong>Command Prompt</strong> window:</p>
<a class="reference internal image-reference" href="../../../_images/bascule_output.png"><img alt="the end of the output of GCP Bascule" class="align-center" src="../../../_images/bascule_output.png" style="width: 600px;" /></a>
<p>As long as your errors aren’t large (&lt;2 pixels or so), you can move on. If you have large errors, you’ll need to carefully check the locations of your GCPs. If you scroll up in the <strong>Command Prompt</strong> window, you should see a report for each of the GCPs you have input, including which image has the largest error (<strong>ErrMax</strong>). You can use this information to decide which image and which GCP needs to be fixed, either by moving it or by deleting the GCP from the image.</p>
<p>The next step is to run <code class="docutils literal notranslate"><span class="pre">SaisieAppuisPredicQT</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mm3d</span> <span class="n">SaisieAppuisPredicQT</span> <span class="s2">&quot;OIS-Reech_AR584003415999[4-7].tif&quot;</span> <span class="n">TerrainInit</span> <span class="n">GCPs</span><span class="o">.</span><span class="n">xml</span> <span class="n">MeasuresFinales</span><span class="o">.</span><span class="n">xml</span>
</pre></div>
</div>
<p>This will place markers at their approximate locations in the images, making it easier to find the control points in the image. Note that the parameter <code class="docutils literal notranslate"><span class="pre">&quot;OIS-Reech_AR584003415999[4-7].tif&quot;</span></code> will open 4 images (<strong>9994</strong>, <strong>9995</strong>, <strong>9996</strong>, and <strong>9997</strong>), which can be memory-intensive. If need be, you can proceed one image at a time, or by only opening 2 images (e.g., replace <code class="docutils literal notranslate"><span class="pre">&quot;OIS-Reech_AR584003415999[4-7].tif&quot;</span></code> with <code class="docutils literal notranslate"><span class="pre">&quot;OIS-Reech_AR584003415999[4-5].tif&quot;</span></code> to only open images <strong>9994</strong> and <strong>9995</strong>). The window should now look something like this (note that the image order may be different – if you look just above the table on the right-hand side, you can see which image is which by hovering over them):</p>
<a class="reference internal image-reference" href="../../../_images/saisie_predict.jpg"><img alt="the saisiepredict window, showing 4 images plus predicted gcp locations" class="align-center" src="../../../_images/saisie_predict.jpg" style="width: 600px;" /></a>
<p>From here, locate and validate as many of the points as you can – it’s not strictly necessary to do all of them, but it can help to improve the final results. I recommend trying to do at least a few of the ones at higher elevations, for reasons that should be clear from the lectures. Remember to check the orthoimages provided to be sure you’re finding the right points – don’t just accept the estimated locations. Once you’ve accepted points from the first four images (<strong>9994</strong>-<strong>9997</strong>), you’ll need to exit Saisie (<strong>File</strong> &gt; <strong>Exit</strong>), and re-run the command to input points to the remaining images:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mm3d</span> <span class="n">SaisieAppuisPredicQT</span> <span class="s2">&quot;OIS-Reech_AR584003415999[6-9].tif&quot;</span> <span class="n">TerrainInit</span> <span class="n">GCPs</span><span class="o">.</span><span class="n">xml</span> <span class="n">MeasuresFinales</span><span class="o">.</span><span class="n">xml</span>
</pre></div>
</div>
</div>
<div class="section" id="bundle-adjustment">
<h2>bundle adjustment<a class="headerlink" href="#bundle-adjustment" title="Permalink to this headline"></a></h2>
<p>Once you’ve input enough GCPs (at least 10), you can run <code class="docutils literal notranslate"><span class="pre">GCPBascule</span></code> again, which will refine the transformation estimated in the previous steps:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mm3d</span> <span class="n">GCPBascule</span> <span class="s2">&quot;OIS.*tif&quot;</span> <span class="n">TerrainInit</span> <span class="n">TerrainBrut</span> <span class="n">GCPs</span><span class="o">.</span><span class="n">xml</span> <span class="n">MeasuresFinales</span><span class="o">-</span><span class="n">S2D</span><span class="o">.</span><span class="n">xml</span>
</pre></div>
</div>
<p>The next step is to run <code class="docutils literal notranslate"><span class="pre">Campari</span></code>, which will perform the bundle adjustment and refine the camera calibration even further:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mm3d</span> <span class="n">Campari</span> <span class="s2">&quot;OIS.*tif&quot;</span> <span class="n">TerrainBrut</span> <span class="n">TerrainFinal</span> <span class="n">GCP</span><span class="o">=</span><span class="p">[</span><span class="n">GCPs</span><span class="o">.</span><span class="n">xml</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="n">MeasuresFinales</span><span class="o">-</span><span class="n">S2D</span><span class="o">.</span><span class="n">xml</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="n">SH</span><span class="o">=</span><span class="n">HomolMasqFiltered</span> <span class="n">AllFree</span><span class="o">=</span><span class="mi">1</span>
</pre></div>
</div>
<p>The numerical values in the GCP option (<code class="docutils literal notranslate"><span class="pre">5</span></code> and <code class="docutils literal notranslate"><span class="pre">2</span></code> in <code class="docutils literal notranslate"><span class="pre">GCP=[GCPs.xml,5,MeasuresFinales-S2D.xml,2]</span></code>) are the estimate of the GCP accuracy in world coordinates (first number) and in pixels (second number). For now, I recommend keeping them at these default values, but feel free to experiment after you’ve gotten the hang of it somewhat.</p>
<p>You should notice that the output for <code class="docutils literal notranslate"><span class="pre">Campari</span></code> tells you which control point has the greatest error (in pixels), and for which image. If your errors are large, this can be a hint as to which GCPs you should try to re-position (running <code class="docutils literal notranslate"><span class="pre">SaisiePredicQT</span></code> again, followed by <code class="docutils literal notranslate"><span class="pre">GCPBascule</span></code> and <code class="docutils literal notranslate"><span class="pre">Campari</span></code>) before moving on to the next steps.</p>
</div>
<div class="section" id="dem-extraction-and-orthophoto-generation">
<h2>dem extraction and orthophoto generation<a class="headerlink" href="#dem-extraction-and-orthophoto-generation" title="Permalink to this headline"></a></h2>
<p>The next step is to extract the DEM and create the orthophoto mosaic. First, run <code class="docutils literal notranslate"><span class="pre">Malt</span></code> to do the DEM extraction and create the individual orthophotos:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mm3d</span> <span class="n">Malt</span> <span class="n">Ortho</span> <span class="s2">&quot;OIS.*tif&quot;</span> <span class="n">TerrainFinal</span> <span class="n">MasqImGlob</span><span class="o">=</span><span class="n">filtre</span><span class="o">.</span><span class="n">tif</span> <span class="n">NbVI</span><span class="o">=</span><span class="mi">2</span> <span class="n">ZoomF</span><span class="o">=</span><span class="mi">1</span> <span class="n">DefCor</span><span class="o">=</span><span class="mi">0</span> <span class="n">CostTrans</span><span class="o">=</span><span class="mi">4</span> <span class="n">EZA</span><span class="o">=</span><span class="mi">1</span>
</pre></div>
</div>
<p>This will create two folders, <strong>MEC-Malt</strong> and <strong>Ortho-MEC-Malt</strong>. In <strong>MEC-Malt</strong>, you will find the DEM (<strong>Z_Num9_DeZoom1_STD-Malt.tif</strong>), as well as the correlation image (<strong>Correl_STD-MALT_Num_8.tif</strong>) and the image mask (<strong>AutoMask_STD-MALT_Num_8.tif</strong>). This will also take some time, depending on your computer – on my laptop, it takes around 10-15 minutes for this set of images.</p>
<p>At the end, you can load the final DEM (<strong>Z_Num9_DeZoom1-STD-MALT.tif</strong>) into <strong>QGIS</strong> or <strong>ArcGIS</strong>. The image below shows a comparison between my results (hillshade, red profile line) and the Shuttle Radar Topography Mission (SRTM) DEM (black line):</p>
<a class="reference internal image-reference" href="../../../_images/dem_comparison.png"><img alt="a profile comparison of the two dems" class="align-center" src="../../../_images/dem_comparison.png" style="width: 600px;" /></a>
<p>In <strong>Ortho-MEC-Malt</strong>, you will find an orthorectified version of each of the input images (e.g., <strong>Ort_OIS-Reech…</strong>). To create an orthophoto mosaic, you can run the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mm3d</span> <span class="n">Tawny</span> <span class="n">Ortho</span><span class="o">-</span><span class="n">MEC</span><span class="o">-</span><span class="n">Malt</span> <span class="n">Out</span><span class="o">=</span><span class="n">Orthophotomosaic</span><span class="o">.</span><span class="n">tif</span>
</pre></div>
</div>
<p>This will create a mosaicked version of the images, which you can open using <strong>QGIS</strong> or <strong>ArcGIS</strong>.</p>
</div>
<div class="section" id="cleaning-up-the-outputs">
<h2>cleaning up the outputs<a class="headerlink" href="#cleaning-up-the-outputs" title="Permalink to this headline"></a></h2>
<p>The final step (for now) is to clean up the output DEM and Orthophoto, masking out the parts of the DEM raster that aren’t covered by the images.</p>
<p>First, cd into <strong>MEC-Malt</strong>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">MEC</span><span class="o">-</span><span class="n">Malt</span>
</pre></div>
</div>
<p>Now, copy the <strong>.tfw</strong> file for the DEM to <strong>Correl_STD-MALT_Num_8.tfw</strong> and <strong>AutoMask_STD-MALT_Num_8.tfw</strong>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">copy</span> <span class="n">Z_Num9_DeZoom1_STD</span><span class="o">-</span><span class="n">MALT</span><span class="o">.</span><span class="n">tfw</span> <span class="n">Correl_STD</span><span class="o">-</span><span class="n">MALT_Num_8</span><span class="o">.</span><span class="n">tfw</span>
<span class="n">copy</span> <span class="n">Z_Num9_DeZoom1_STD</span><span class="o">-</span><span class="n">MALT</span><span class="o">.</span><span class="n">tfw</span> <span class="n">AutoMask_STD</span><span class="o">-</span><span class="n">MALT_Num_8</span><span class="o">.</span><span class="n">tfw</span>
</pre></div>
</div>
<p>This will create a worldfile for both the correlation mask and the AutoMask, enabling you to load them into <strong>QGIS</strong> or <strong>ArcGIS</strong>. If you haven’t already, open <strong>QGIS</strong> (or <strong>ArcGIS</strong>), and add these three raster files to the map.</p>
<p>Open the <strong>Raster Calculator</strong>. If you are using <strong>ArcGIS</strong>, skip to the next line below. If you are using <strong>QGIS</strong>, enter the following expression:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;Z_Num9_DeZoom1_STD-Malt@1&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="s2">&quot;AutoMask_STD-Malt_Num_8@1&quot;</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../../../_images/qgis_rastercalc.png"><img alt="the qgis raster calculator window" class="align-center" src="../../../_images/qgis_rastercalc.png" style="width: 600px;" /></a>
<p>This will mask the parts of the DEM that aren’t valid (i.e., <strong>MicMac</strong> wasn’t able to resolve an elevation for them).</p>
<p>If you are using <strong>ArcGIS</strong>, enter the following expression into the <strong>Raster Calculator</strong>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SetNull</span><span class="p">(</span><span class="s2">&quot;AutoMask_STD-MALT_Num_8.tif&quot;</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Z_Num9_DeZoom1_STD-MALT.tif&quot;</span><span class="p">)</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../../../_images/arcgis_rastercalc.png"><img alt="the arcgis raster calculator window" class="align-center" src="../../../_images/arcgis_rastercalc.png" style="width: 600px;" /></a>
<p>Save the masked DEM to your directory as <strong>MtStHelens_DEM.tif</strong> (or similar).</p>
<p>At this point, you’re done – we’ll work a bit more on analyzing our DEMs in the <a class="reference external" href="week2.html">week 2 practical</a>.</p>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="setup.html" class="btn btn-neutral float-left" title="software setup" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="week2.html" class="btn btn-neutral float-right" title="week 2 - dem differencing" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Bob McNabb.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>